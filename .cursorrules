# ICON-ICE-2KG 제빙기 프로젝트 Cursor 룰

## 프로젝트 개요
- **제품**: ICON-ICE-2KG 제빙기 (코웨이)
- **언어**: C (Embedded System)
- **MCU**: R5F100MG (Renesas)
- **주요 기능**: 제빙, 고온살균, 물 추출, IoT 연동
- **인코딩**: Korean (EUC-KR) - 모든 파일은 반드시 Korean 인코딩으로 작성/수정

## 코드 분석 및 수정 가이드라인

### 1. 변수 명명 규칙 이해
- `gu8_`: Global Unsigned 8-bit
- `gu16_`: Global Unsigned 16-bit  
- `gu32_`: Global Unsigned 32-bit
- `f_`: Flag 변수
- `bit_`: Bit 플래그
- `F_`: 대문자 Flag (주요 상태)
- `Bit[N]_`: 비트 필드 정의

### 2. 주요 시스템 구조
- **Source/Ice_Mini/**: 메인 소스 코드 디렉토리
- **Global_Variable.h**: 전역 변수 및 상수 정의
- **eeprom.c**: EEPROM 데이터 저장/읽기
- **M[N]_*.c**: 모듈별 기능 구현

### 3. 고온살균 시스템 이해
#### 살균 모드 순서:
```
PREPARE → HOT_PREHEAT → HOT_INPUT → HOT_WAIT → [DRAIN_PREHEAT → DRAIN_INPUT → DRAIN_WAIT] → FINISH
```

#### 밸브 제어 규칙:
- **일반 밸브**: SET = OPEN, CLEAR = CLOSE
- **NOS 밸브** (HOT DRAIN, OVERFLOW): SET = CLOSE, CLEAR = OPEN
- **살균 중 밸브 상태**:
  - HOT IN: PREHEAT(Step≥2), INPUT(Step 0~4)에서 OPEN
  - HOT DRAIN: INPUT(Step 1~5)에서 CLOSE (NOS)
  - OVERFLOW: PREHEAT(Step≥1), INPUT 중 CLOSE (NOS)
  - ICE TRAY: INPUT(Step 0~5)에서 OPEN
  - COLD IN: DRAIN_INPUT(Step 0~5)에서 OPEN

### 4. 카운터 시스템
- **트레이 살균**: 3회마다 1회 (`PERIODIC__STER_CYCLE = 3`)
- **드레인탱크 살균**: 10회마다 1회 (`DRAIN_TANK__STER_CYCLE = 9`)
- **카운터 리셋 조건**: `count > CYCLE` (off-by-one 주의)

### 5. EEPROM 데이터 무결성
#### 주의사항:
- **읽기/쓰기 인덱스 일치 확인** 필수
- 예: `gu8_drain_tank_ster_count`
  - 쓰기: `gu8_eeprom_wbuf[9]`
  - 읽기: `gu8_eeprom_rbuf[9]` (인덱스 7이 아님!)
- **유효성 검사**: 읽은 값이 유효 범위 내인지 확인

### 6. 버그 패턴 인식
#### 자주 발생하는 버그:
1. **배열 인덱스 불일치**: EEPROM 읽기/쓰기 인덱스 다름
2. **Off-by-one 에러**: `>=` vs `>` 조건 혼용
3. **NOS 밸브 로직 오류**: SET/CLEAR 의미 반대
4. **카운터 오버플로우**: 최대값 초과 시 처리 누락
5. **상태 전환 누락**: 특정 조건에서 상태 변경 안됨

### 7. 코드 수정 시 체크리스트
- [ ] 변수명이 명명 규칙을 따르는가?
- [ ] EEPROM 읽기/쓰기 인덱스가 일치하는가?
- [ ] 카운터 범위 검사가 올바른가?
- [ ] NOS 밸브 제어 로직이 올바른가?
- [ ] 상태 전환이 모든 경우에 처리되는가?
- [ ] 주석에 변경 이유와 날짜가 기록되어 있는가?
- [ ] **파일 인코딩이 Korean (EUC-KR)으로 설정되어 있는가?**

### 8. 주석 규칙
```c
/* 기능 설명 YYMMDD 작성자 */
/*..hui [YY-M-D시간] 상세 설명..*/
```

### 9. 디버깅 접근법
1. **변수 추적**: 전역 변수의 값 변화 추적
2. **상태 머신 분석**: 현재 상태와 전환 조건 확인
3. **타이밍 이슈**: 타이머 및 지연 시간 검토
4. **하드웨어 연동**: 밸브, 센서 상태 확인

### 10. 성능 최적화
- **메모리 사용량**: 전역 변수 최소화
- **실행 시간**: 긴 루프나 지연 최소화
- **전력 소모**: 불필요한 하드웨어 동작 방지

## 파일별 주요 기능
- **ster_ice_tray.c**: 트레이 살균 메인 로직
- **ster_ice_tray_op.c**: 살균 동작 제어
- **valve_*.c**: 각 밸브별 제어 로직
- **eeprom.c**: 설정값 저장/복원
- **display_*.c**: 사용자 인터페이스
- **M*_*.c**: 시스템 모듈별 기능

## 테스트 가이드라인
1. **단위 테스트**: 각 함수별 입출력 검증
2. **통합 테스트**: 살균 전체 시퀀스 검증
3. **경계값 테스트**: 카운터 최대/최소값 테스트
4. **예외 상황**: 전원 차단, 센서 오류 등

## 파일 인코딩 규칙
- **필수 인코딩**: Korean (EUC-KR)
- **적용 대상**: 모든 .c, .h 파일
- **주의사항**: 
  - 한글 주석이 포함된 파일은 반드시 Korean 인코딩 사용
  - UTF-8로 저장 시 한글이 깨질 수 있음
  - IDE에서 파일 생성/수정 시 인코딩 확인 필수

이 룰을 따라 코드를 분석하고 수정하면 버그를 줄이고 안정성을 높일 수 있습니다.
