# ICON-ICE-2KG 제빙기 프로젝트 Cursor 룰

## 프로젝트 개요
- **제품**: ICON ICE 2KG MAX (CHPI-7420N) - 코웨이 얼음 정수기
- **모델명**: CHPI-7420N
- **현재 버전**: V1.0.0.9 (2025-12-24)
- **언어**: C (Embedded System)
- **MCU**: R5F100SJ (Renesas RL78)
- **인코딩**: UTF-8 - **모든 파일은 반드시 UTF-8 인코딩으로 작성/수정**

## 주요 제품 사양
### 기능
- **정수**: 직수형
- **냉수**: 탱크형 (1L)
- **온수**: 직수형 (순간온수, 2750W)
- **온수 온도**: 100℃, 85℃, 70℃, 45℃ 선택 가능
- **냉각 시스템**: 압축기(인버터) R600a, 듀얼 냉각 시스템
- **추출량**: 반컵(120ml), 한컵(250ml), 두컵(500ml), 네컵(1000ml), 연속
- **제빙 용량**: 2KG
- **얼음 종류**: 일반 얼음, 조각 얼음
- **얼음물**: 150ml, 250ml, 350ml, 500ml (4단계)
- **UV 케어**: 출수파우셋, 얼음파우셋(1,2), 얼음트레이, 얼음저장고(1,2,3)
- **고온 살균**: 트레이(3일 주기), 드레인탱크(6일 주기)
- **IoT**: Wi-Fi, UART 통신

### 하드웨어 구성
#### 밸브 (초기 상태)
- NOS 밸브: OPEN (누수/물넘침 시 동작)
- 온수 입수 밸브: CLOSE
- 온수 출수 밸브: CLOSE
- 온수 배수 밸브 (NOS): CLOSE
- 얼음물 출수 밸브: CLOSE
- 냉수 입수 밸브: CLOSE
- 정수 입수 밸브: CLOSE
- 정수/냉수 출수 밸브: CLOSE
- 냉수 배수 밸브: CLOSE
- 아이스 트레이 입수 밸브: CLOSE
- 오버플로우 밸브 (NOS): CLOSE

#### 센서
- 환경 온도 센서 1,2 (E43, E53)
- 정수 온도 센서 (E42)
- 냉수 온도 센서 (E44)
- 증발기 온도 센서
- 온수 입수 온도센서 (E46)
- 온수 출수 온도센서 (E47)
- 히터 내부 온도 센서 (E48)
- 누수 감지 센서 (E01)
- 유량 센서 (E09 단수 감지)
- 만빙/저빙 센서 (광센서)
- 배수 탱크 저수위/만수위 센서

#### 모터
- **스테핑 모터**: 온수 유량 조절, 냉매 전환 밸브, 얼음 추출 도어, 얼음 선택 도어, 아이스 트레이
- **AC 모터**: 아이스 분쇄모터, 아이스 토출(Feeder Screw)
- **펌프**: 배수 펌프 (E60)
- **압축기**: BLDC 컴프레서 (E27, E80~E86)

## 코드 분석 및 수정 가이드라인

### 1. 변수 명명 규칙
```c
// 전역 변수
gu8_*   // Global Unsigned 8-bit
gu16_*  // Global Unsigned 16-bit
gu32_*  // Global Unsigned 32-bit
gs8_*   // Global Signed 8-bit
gs16_*  // Global Signed 16-bit

// 플래그
f_*     // Flag 변수
bit_*   // Bit 플래그
F_*     // 대문자 Flag (주요 상태)
Bit[N]_* // 비트 필드 정의 (예: Bit0_Cold_Operation_Disable_State)

// 로컬 변수
mu8_*   // Module/Local Unsigned 8-bit
u8_*    // Local Unsigned 8-bit
```

### 2. 주요 시스템 구조
```
Source/
├── Ice_Mini/              # 메인 소스 코드 (260 files)
│   ├── Global_Variable.h  # 전역 변수/상수 정의
│   ├── eeprom.c/h         # EEPROM 저장/읽기
│   ├── M*_*.c             # 모듈별 기능 (M7_Error_Control, M9_Data_Save 등)
│   ├── ster_ice_tray.c    # 트레이 살균 메인 로직
│   ├── ster_ice_tray_op.c # 살균 동작 제어
│   ├── valve_*.c          # 각 밸브별 제어 로직
│   ├── display_*.c        # 사용자 인터페이스
│   ├── AC_motor_output.c  # 얼음 추출 모터 제어
│   └── error_*.c/h        # 에러 관리
├── Core/                  # 코어 라이브러리
├── User/                  # User_Main.c
└── Wifi/                  # Wi-Fi 통신 모듈
```

### 3. 고온살균 시스템 (**최신 V1.0.0.9 반영**)
#### 트레이 살균 (3일에 1회)
```
상태 순서:
NONE → PREPARE → HOT_PREHEAT → HOT_INPUT → HOT_WAIT
→ [DRAIN_PREHEAT → DRAIN_INPUT → DRAIN_WAIT] → FINISH

PERIODIC__STER_CYCLE = 3  // 트레이 살균 주기
```

#### 드레인탱크 살균 (6일에 1회) - **V1.0.0.9 변경**
```c
DRAIN_TANK__STER_CYCLE = 1  // 변경: 30일 → 6일
// 트레이 살균 2회당 1회 = 6일에 1회
```

#### 밸브 제어 규칙
```c
// **일반 밸브**: SET(1, HIGH) = OPEN, CLEAR(0, LOW) = CLOSE
// **NOS 밸브** (HOT DRAIN, OVERFLOW): SET(1, HIGH) = CLOSE, CLEAR(0, LOW) = OPEN

// 살균 중 밸브 상태 (Step은 0부터 시작)
// - HOT IN (온수입수): PREHEAT(Step≥2), INPUT(Step 0~4)에서 OPEN
// - HOT DRAIN (온수배수, NOS): INPUT(Step 1~5)에서 CLOSE
// - OVERFLOW (NOS): PREHEAT(Step≥1), INPUT 중 CLOSE
// - ICE TRAY (트레이입수): INPUT(Step 0~5)에서 OPEN
// - COLD IN (냉수입수): DRAIN_INPUT(Step 0~5)에서 OPEN
```

### 4. 카운터 시스템
```c
// 트레이 살균 카운터
if( gu8_periodic_ster_count >= PERIODIC__STER_CYCLE )  // 3 >= 3: TRUE
{
    // 살균 실행
    gu8_periodic_ster_count = 0;  // 리셋
}
gu8_periodic_ster_count++;  // 매 살균 완료 후 증가

// 드레인탱크 살균 카운터
if( gu8_drain_tank_ster_count >= DRAIN_TANK__STER_CYCLE )  // 1 >= 1: TRUE
{
    // 드레인탱크 살균 실행
}
gu8_drain_tank_ster_count++;

if( gu8_drain_tank_ster_count > DRAIN_TANK__STER_CYCLE )  // 2 > 1: TRUE
{
    gu8_drain_tank_ster_count = 0;  // 리셋
}

// ⚠️ 주의: >= vs > 조건 혼용 (off-by-one 주의!)
```

### 5. 에러 코드 시스템
```c
// 주요 에러 코드
E01  // 누수 에러
E08  // 온수 드레인 막힘
E09  // 원수 단수 에러
E27  // 압축기 통신 에러
E40  // 히터 과열
E42  // 정수 온도 센서 에러
E43  // 외기 온도 센서 1 에러
E44  // 냉수 온도 센서 에러
E46  // 온수 입수 온도 센서 에러
E47  // 온수 출수 온도 센서 에러
E48  // 히터 내부 온도 센서 에러
E53  // 외기 온도 센서 2 에러
E60  // 배수 펌프 에러
E61  // 트레이 이동 에러 (제빙 위치)
E62  // 트레이 이동 에러 (탈빙 위치)
E63  // 트레이 위치 감지 에러
E80~E86  // BLDC 인버터 에러

// 에러 비트 정의 (U32ControlErrorsD)
Bit0_Hot_Water_Flow_Block_Error__E08
Bit1_Main_Water_Flow_Leaked_Error__E02
Bit2_Room_Temp_Open_Short_Error__E42
Bit3_Leakage_Sensor_Error__E01
Bit4_Hot_In_Temp_Open_Short_Error__E46
Bit5_Hot_Heater_OverHeat_Error__E40
Bit6_Main_Water_Flow_Block_Error__E09
Bit7_BLDC_Communication_Error__E27
```

### 6. EEPROM 데이터 무결성
```c
// ⚠️ **필수**: 읽기/쓰기 인덱스 일치 확인!
// 예: gu8_drain_tank_ster_count
gu8_eeprom_wbuf[9] = gu8_drain_tank_ster_count;  // 쓰기: 인덱스 9
gu8_drain_tank_ster_count = gu8_eeprom_rbuf[9];  // 읽기: 인덱스 9 (일치!)

// EEPROM 주소 정의
#define EEPROM_ADDR6_DRAIN_TANK_STER_COUNT   0x00A9

// 유효성 검사
if(gu8_eeprom_rbuf[9] <= 10)  // 범위 확인
{
    gu8_drain_tank_ster_count = gu8_eeprom_rbuf[9];
}
else
{
    gu8_drain_tank_ster_count = 0;  // 기본값
    EepromByteWrite(EEPROM_ADDR6_DRAIN_TANK_STER_COUNT, gu8_drain_tank_ster_count);
}
```

### 7. 얼음 추출 제어
#### 단계별 추출 시간
```c
// 일반 얼음 (Feeder 정회전 시간)
1단계: 4.0초 (4초 전진)
2단계: 6.0초 (4초 → 1초 정지 → 1초) [정회전 5초]
3단계: 7.0초 (4초 → 1초 정지 → 2초) [정회전 6초]
4단계: 8.0초 (4초 → 1초 정지 → 3초) [정회전 7초]

// 연속(누름) 추출
일반얼음: 3초 동작 → 1초 정지 반복 (2분간 정회전 총 90초)
조각얼음: 2초 동작 → 1초 정지 반복 (2분간 정회전 총 80초)

// 조각 얼음
1단계: 25초 [정회전 17초]
2단계: 39초 [정회전 26초]
3단계: 53초 [정회전 36초]
4단계: 76초 [정회전 51초]

// 얼음물 단계별 용량
1단계: 얼음1단계/150ml
2단계: 얼음2단계/250ml
3단계: 얼음3단계/350ml
4단계: 얼음4단계/500ml
```

#### 정역회전 제어
```c
// 3초~6초 미만 추출 후
// 9초 대기 → 1초 역회전

// 6초 이상 추출 후
// 9초 대기 → 3초 역회전
// 재추출 시: 역회전 완료 → 1초 대기 → 정회전

// 조각얼음 추출 시작
// 셀렉트(이너)도어 100% (1100 Pulse) CLOSE 후 추출
```

#### 도어 제어
```c
// ICE DOOR 펄스: 800 Pulse (110% = 880 Pulse Margin 포함)
// SELECT(INNER) DOOR 펄스: 1100 Pulse
//
// 추출 완료 후:
// - SELECT(INNER) DOOR: 3초 대기 → CLOSE
// - ICE DOOR: 7초 대기 → CLOSE
//
// 20분 경과 시: ICE DOOR 60% (480 Pulse) CLOSE (1회 한정)
// 24시간마다: 강제 CLOSE
```

### 8. 온수 제어 (**V1.0.0.9 업데이트**)
```c
// 예열
// 최대 15초 예열
// 온수 방치 추출 안정화 (V1.0.0.9 신규)
if( (설정온도 >= 90℃) && (재추출 아님) && (히터내부온도 >= 40℃) )
{
    예열온도 = 82℃;  // 고정
}

// 추출
// 정량: 설정 유량 달성 시 종료
// 연속: 최대 3분
// 버튼 8초 이상 누름: 강제 종료

// 히터 제한
if( 출수온도 >= 106℃ || 히터내부온도 >= 106℃ )
{
    히터출력 = 60%;
}
if( 출수온도 >= 99℃ )
{
    히터출력 = 80%;
}
if( 히터내부온도 >= 98℃ ) 히터출력 = 85%;
if( 히터내부온도 >= 96℃ ) 히터출력 = 80%;

// 저유량 감지
if( 유량 < 0.25LPM, 1초 연속 )
{
    히터출력 = 60%;
}
if( 유량 < 0.1LPM, 1초 연속 )
{
    E08 에러 발생;
}
```

### 9. 냉수/냉각 제어
```c
// 냉수 온도 표시: 2~30℃ 제한
// 온도 업데이트: 10초마다 1℃씩 상승/하강

// 냉수 [강] (일반 모드)
진입: 7.5℃, 해제: 5.8℃

// 냉수 [약] (V1.0.0.9 기준)
진입: 11.0℃, 해제: 7.0℃, 유지시간: 2초

// 빠른 제빙 (만빙 아님)
진입: 15℃, 해제: 7.5℃

// 빠른 제빙 (만빙)
진입: 7.5℃, 해제: 5.8℃

// 취침 모드
외기 ≤ 10℃: 진입 10℃, 해제 6.5℃
외기 > 10℃: 진입 10℃, 해제 5.8℃
```

### 10. 드레인 탱크 배수 (**V1.0.0.9 업데이트**)
```c
// 동작 조건
1) 얼음 가득 상태
2) 드레인탱크 중수위 또는 만수위 상태에서 얼음기능 OFF
3) 전원 ON 시 저수위 상태
4) 중수위 1시간 경과 (V1.0.0.9: 3시간 → 1시간 변경)
5) 만수위 도달
6) 저수위 센서 불량 (만수위만 감지)
7) 핫가스 동작 중 중수위
8) 고온살균 탱크 배수
9) 온수 추출 완료 후 중수위 이상 (V1.0.0.9 신규)

// 펌프 제어
최초: 3초 24V → 이후 약 70% 전압
재시도: 24V로 가동

// 에러 감지 (E60)
10분 ON → 1분 대기 → 수위확인
저수위 감지 시: 2분 ON/1분 OFF 12회 반복
반복 후에도 저수위 감지: E60 발생

// 물 없음 감지
펌프 10초 이상 가동 + 전류 AD 180 이하 10초 이상 → 물 없음
```

### 11. UV 케어 시스템
```c
// UV 위치
P13.0:  트레이 UV
P0.7:   얼음탱크 UV 1,2
P10.2:  얼음탱크 UV 3

// 트레이 UV 동작 (V1.0.0.1 변경)
탈빙: 2회 (기존 3회)
제빙: 4회 (기존 7회)

// UV 에러 AD 기준값 (V1.0.0.1 변경)
물파우셋: 205/41
얼음파우셋 1,2: 205/41
얼음탱크 1,2: 410/120
얼음트레이 1,2: 410/120
얼음탱크 3: 205/41

// 얼음기능 OFF 시 UV 제어 (V1.0.0.9 신규)
// 조건: 얼음기능 OFF + 초기 더미탈빙 완료 + 제빙/플러싱/고온살균 아님 + 탱크커버 닫힘
// 동작: 트레이 UV + 얼음탱크 UV 1,2,3 살균
```

### 12. 제빙 시스템
```c
// 제빙 테이블: V31-2
// 탈빙 시간
20~24℃: 45초 (기존 35초 + 10초)
25~29℃: 35초 (기존 25초 + 10초)

// 트레이 제어 속도: 166pps (기존 125pps)
// 트레이 down: 단계제어 적용

// 외기 센서 2개 모두 에러 시
// 제빙 가능 (25℃ 기준 동작)
// 얼음/얼음물 추출 시 에러 안내음성 발생

// 트레이 입수 중 단수 시
// E09 판단 안함
// 2.5분 간 미입수 → 10분 대기 → 재시도
```

### 13. 버그 패턴 인식
#### 자주 발생하는 버그:
1. **배열 인덱스 불일치**: EEPROM 읽기/쓰기 인덱스 다름
2. **Off-by-one 에러**: `>=` vs `>` 조건 혼용
3. **NOS 밸브 로직 오류**: SET/CLEAR 의미 반대
4. **카운터 오버플로우**: 최대값 초과 시 처리 누락
5. **상태 전환 누락**: 특정 조건에서 상태 변경 안됨
6. **타이머 리셋 누락**: 조건 만족 시 타이머 초기화 누락
7. **동시 추출 제어**: 얼음+물 동시 추출 시 밸브 충돌

### 14. 코드 수정 시 체크리스트
- [ ] 변수명이 명명 규칙을 따르는가?
- [ ] EEPROM 읽기/쓰기 인덱스가 일치하는가?
- [ ] 카운터 범위 검사가 올바른가? (`>=` vs `>`)
- [ ] NOS 밸브 제어 로직이 올바른가? (SET=CLOSE, CLEAR=OPEN)
- [ ] 상태 전환이 모든 경우에 처리되는가?
- [ ] 타이머가 적절히 초기화/리셋되는가?
- [ ] 주석에 변경 이유와 날짜가 기록되어 있는가?
- [ ] **파일 인코딩이 UTF-8로 설정되어 있는가?**
- [ ] V1.0.0.9 변경사항이 반영되었는가?
  - [ ] 드레인탱크 살균 주기: 6일 (DRAIN_TANK__STER_CYCLE = 1)
  - [ ] 중수위 펌프 동작: 1시간
  - [ ] 온수 추출 후 배수 기능
  - [ ] 얼음OFF 시 UV 살균
  - [ ] 온수 방치 예열: 82℃

### 15. 주석 규칙
```c
/* 기능 설명 YYMMDD 작성자 */
/*..hui [YY-M-D시간] 상세 설명..*/
/* [YYYY-MM-DD] 작성자 간략 설명 */

// 예시
/* [2025-12-19] CH.PARK 드레인탱크 고온살균 주기 30일 → 1일로 변경 */
/*..hui [25-7-7오후 12:24:04] 이건 수동살균 횟수 포함..*/
```

### 16. 디버깅 접근법
1. **변수 추적**: 전역 변수의 값 변화 추적 (gu8_*, gu16_*)
2. **상태 머신 분석**: 현재 상태(`gu8_ice_ster_mode`, `gu8_ice_making_state` 등)와 전환 조건 확인
3. **타이밍 이슈**: 타이머(`gu16_*_timer`, `gu32_*_timer`) 및 지연 시간 검토
4. **하드웨어 연동**: 밸브, 센서, 모터 상태 확인
5. **에러 비트**: `u32ControlErrors` 비트 플래그 확인

### 17. 성능 최적화
- **메모리 사용량**: 전역 변수 최소화, 불필요한 배열 크기 축소
- **실행 시간**: 긴 루프나 지연 최소화, 타이머 기반 제어 활용
- **전력 소모**: 불필요한 하드웨어 동작 방지 (펌프, 압축기, 히터)

## 파일별 주요 기능
```
ster_ice_tray.c           # 트레이 살균 메인 상태 머신
ster_ice_tray_op.c        # 살균 단계별 동작 제어
ster_ice_tray_hot.c       # 고온 살균 온도 제어
valve_*.c                 # 밸브별 제어 로직
eeprom.c                  # 설정값 저장/복원, EEPROM 무결성
M7_Error_Control.c        # 에러 관리 및 처리
M9_Data_Save.c            # 데이터 변경 감지 및 저장
display_*.c               # 사용자 인터페이스, FND 표시
AC_motor_output.c         # 얼음 추출 모터 제어
ice_making.c              # 제빙 로직
hot_water_*.c             # 온수 제어
cold_water_*.c            # 냉수 제어
drain_*.c                 # 드레인 펌프 제어
uv_*.c                    # UV 살균 제어
```

## 테스트 가이드라인
1. **단위 테스트**: 각 함수별 입출력 검증
2. **통합 테스트**: 살균 전체 시퀀스 검증
3. **경계값 테스트**:
   - 카운터 최대/최소값
   - 온도 범위 (2~30℃)
   - 타이머 오버플로우
4. **예외 상황**:
   - 전원 차단 (정전 보상 동작)
   - 센서 오류 (E42~E48)
   - 단수 (E09)
   - 펌프 오류 (E60)
   - 커버 열림 (살균 중단)
5. **V1.0.0.9 검증**:
   - 드레인탱크 살균 6일 주기
   - 중수위 1시간 펌프 동작
   - 온수 추출 후 배수
   - 얼음OFF 시 UV 동작
   - 온수 방치 82℃ 예열

## 파일 인코딩 규칙
- **필수 인코딩**: UTF-8
- **적용 대상**: 모든 .c, .h 파일
- **주의사항**:
  - 한글 주석이 포함된 파일은 반드시 UTF-8 인코딩 사용
  - 다른 인코딩으로 저장 시 한글이 깨질 수 있음
  - IDE에서 파일 생성/수정 시 인코딩 확인 필수
  - 빌드 전 인코딩 검증 권장

## V1.0.0.9 주요 변경사항 (2025-12-24)
### 1. 드레인탱크 E60 개선
- **1.1** 중수위 펌프 동작 시간: 3시간 → **1시간**
- **1.2** 온수 추출 후 배수 기능 **신규 추가**
- **1.3** 드레인탱크 살균 주기: 30일 → **6일**

### 2. 얼음기능 OFF 시 UV 살균 **신규 추가**
- 트레이 UV (P13.0) + 얼음탱크 UV (P0.7, P10.2) 동작

### 3. 온수 방치 추출 안정화
- 90/95/100℃ 재추출 아님 + 히터 ≥ 40℃ → 예열온도 **82℃ 고정**

---

이 룰을 따라 코드를 분석하고 수정하면 버그를 줄이고 안정성을 높일 수 있습니다.
제어사양서의 모든 핵심 내용을 반영했으며, V1.0.0.9 변경사항까지 완전히 반영되었습니다.
